# GitHub Copilot Instructions for Coffee Bot Backend

## Project Context
This is a **Telegram Coffee Bot Backend** built with:
- **FastAPI** (REST API)
- **Telethon** (Telegram bot library)
- **Beanie ODM** (MongoDB async ORM)
- **Google Sheets API** (data backup)

## Default Paths & Environment
- **Project Root**: `c:\Users\Lukas\git\coffee bot\telegram_coffee_bot_backend`
- **Python Virtual Environment**: `venv\Scripts\python.exe` (Windows)
- **Activation Command**: `venv\Scripts\activate`
- **Start Command**: `python -m src.main`
- **Main Entry Point**: `src/main.py`

## Key Development Patterns

### Starting the Application
Always use:
```bash
cd "c:\Users\Lukas\git\coffee bot\telegram_coffee_bot_backend"
venv\Scripts\activate
python -m src.main
```

### Beanie Link Handling
- **Never access**: `document.link_field.attribute` directly
- **Always use**: `await document.fetch_link("link_field")` first
- **For queries**: Use `Model.find(Model.link_field == document)` 
- **Not**: `Model.find(Model.link_field.id == document.id)`

### Project Structure
```
src/
├── main.py                # FastAPI app entry point
├── config.py              # Configuration settings
├── common/                # Utility functions
│   ├── helper.py          # Common utility functions
│   └── log.py             # Logging utilities
├── dependencies/
│   └── dependencies.py    # Dependency injection
├── models/
│   ├── beanie_models.py   # User models (TelegramUser, FullUser)
│   ├── coffee_models.py   # Coffee system models
│   └── base_models.py     # Abstract base classes
├── schemas/
│   ├── user.py            # Pydantic schemas for users
│   └── serializer.py      # Serializers for API responses
├── handlers/
│   └── coffee_handlers.py # Business logic
├── routers/
│   ├── coffee.py          # Coffee API endpoints
│   └── auth.py            # Authentication
├── database/              # Database connection & repo
└── api/                   # External API integrations
    ├── telethon_api.py    # Telegram API integration
    └── gsheet_api.py      # Google Sheets API integration
```

### Common Tasks & Commands

#### Running Tests
```bash
python -m pytest tests/
```

### Code Standards
- Use **async/await** for all database operations
- Handle **Beanie Links** properly (fetch before access)
- **Decimal** for currency amounts, not float
- **datetime** objects for timestamps
- Proper error handling with meaningful messages

### Current Features
1. **Coffee Cards**: Physical coffee card tracking
2. **Orders**: Individual coffee consumption
3. **Debts**: Automatic debt calculation between users
4. **Payments**: Simple payment recording (no external processing)
5. **Sessions**: Group coffee ordering
6. **Google Sheets**: Data backup/visualization

### Payment System
- **Simplified**: No PayPal or external payment processing
- **Payment Creation = Completion**: Once payment record exists, it's considered paid
- **Debt Settlement**: Automatic when payments are recorded
- **Methods**: Cash, Bank Transfer, Manual, PayPal

### Environment Variables (.env)
```
MONGODB_URL=mongodb://localhost:27017
DATABASE_NAME=coffee_bot
TELEGRAM_API_ID=...
TELEGRAM_API_HASH=...
TELEGRAM_BOT_TOKEN=...
SECRET_KEY=...
```

### VS Code Tasks Available
- **Start Coffee Bot Backend**: Runs `python -m src.main` with venv
- **Project directory**: `c:\Users\Lukas\git\coffee bot\telegram_coffee_bot_backend`

## Instructions for AI Assistant
1. **Always activate venv** before running Python commands
2. **Use absolute paths** when possible
3. **Check current file contents** before making edits (user might have made changes)
4. **Prefer Beanie document operations** over raw MongoDB queries
5. **Handle Link relationships** properly (fetch before access)
6. **Test changes** by attempting to start the server
7. **Use existing patterns** from the codebase
8. **Selective** edit only the code which is requested to be changed
9. **Always use pydantic models** for data validation and serialization

## Debugging Tips
- Import errors → Check venv activation
- Link attribute errors → Use `fetch_link()` first  
- Database connection → Check MongoDB running
- Telegram errors → Verify API credentials
